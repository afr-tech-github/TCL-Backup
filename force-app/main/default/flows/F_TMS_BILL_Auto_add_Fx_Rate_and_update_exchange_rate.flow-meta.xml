<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>57.0</apiVersion>
    <decisions>
        <name>Check_condition</name>
        <label>Check condition</label>
        <locationX>807</locationX>
        <locationY>559</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Fx_Rate_is_null</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>$Record.FxRateID__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.CreatedDate</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Fx_Rate_avaible</targetReference>
            </connector>
            <label>Fx Rate is null</label>
        </rules>
        <rules>
            <name>Fx_Rate_is_changed</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.FxRateID__r.Id</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_F_TMS_Bill_0_0</targetReference>
            </connector>
            <label>Fx-Rate is changed</label>
        </rules>
        <rules>
            <name>Exchange_Rate_is_changed</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>$Record.ExchangeRateSelling__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.ExchangeRateBuying__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_F_TMS_Bill_0</targetReference>
            </connector>
            <label>Exchange Rate is changed</label>
        </rules>
        <rules>
            <name>Unit_Price_is_change</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>$Record.UnitPriceFCY__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.UnitPriceofSellingLocal__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.UnitPriceofBuyingFCY__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.UnitPriceofBuyingLocal__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_F_TMS_Bill_0</targetReference>
            </connector>
            <label>Unit Price is change</label>
        </rules>
    </decisions>
    <decisions>
        <name>CheckIfNull</name>
        <label>CheckIfNull</label>
        <locationX>617</locationX>
        <locationY>806</locationY>
        <defaultConnector>
            <targetReference>Update_F_TMS_Bill_0_0_0</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Fx_Rate_avaible</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_F_TMS_Bill</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <environments>Default</environments>
    <formulas>
        <name>CurrencyConversionforBuying</name>
        <dataType>String</dataType>
        <expression>CASE({!$Record.CurrencyBuying__c},&apos;USD&apos;,&quot;From Local Currency to FCY&quot;,&quot;From FCY to Local Currency&quot;)</expression>
    </formulas>
    <formulas>
        <name>CurrencyConversionforSelling</name>
        <dataType>String</dataType>
        <expression>CASE({!$Record.CurrencySelling__c},&apos;USD&apos;,&quot;From Local Currency to FCY&quot;,&quot;From FCY to Local Currency&quot;)</expression>
    </formulas>
    <formulas>
        <name>CurrencySelling</name>
        <dataType>Boolean</dataType>
        <expression>ISPICKVAL({!$Record.CurrencySelling__c},&apos;VND&apos;)</expression>
    </formulas>
    <formulas>
        <name>UnitPriceofBuyingFCY</name>
        <dataType>Number</dataType>
        <expression>IF(ISPICKVAL({!$Record.CurrencyBuying__c},&apos;VND&apos;),{!$Record.UnitPriceofBuyingLocal__c}/{!$Record.ExchangeRateBuying__c},{!$Record.UnitPriceofBuyingFCY__c})</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <name>UnitPriceofBuyingLocal</name>
        <dataType>Number</dataType>
        <expression>IF(ISPICKVAL({!$Record.CurrencyBuying__c},&apos;VND&apos;),{!$Record.UnitPriceofBuyingLocal__c},{!$Record.ExchangeRateBuying__c}*{!$Record.UnitPriceofBuyingFCY__c})</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <name>UnitPriceofSellingFCY</name>
        <dataType>Number</dataType>
        <expression>IF(ISPICKVAL({!$Record.CurrencySelling__c},&apos;VND&apos;),{!$Record.UnitPriceofSellingLocal__c}/{!$Record.ExchangeRateSelling__c},{!$Record.UnitPriceFCY__c})</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <name>UnitPriceofSellingLocal</name>
        <dataType>Number</dataType>
        <expression>IF(ISPICKVAL({!$Record.CurrencySelling__c},&apos;VND&apos;),{!$Record.UnitPriceofSellingLocal__c},{!$Record.ExchangeRateSelling__c}*{!$Record.UnitPriceFCY__c})</expression>
        <scale>2</scale>
    </formulas>
    <interviewLabel>F/TMS BILL| Auto add Fx Rate and {!$Flow.CurrentDateTime}</interviewLabel>
    <label>F/TMS BILL| Auto add Fx Rate and update exchange rate</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Get_Fx_Rate_avaible</name>
        <label>Get Fx Rate avaible</label>
        <locationX>772</locationX>
        <locationY>806</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>CheckIfNull</targetReference>
        </connector>
        <filterLogic>1 AND 2 AND 3 AND (4 OR 5)</filterLogic>
        <filters>
            <field>Active__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Start_Date__c</field>
            <operator>LessThanOrEqualTo</operator>
            <value>
                <elementReference>$Record.CreatedDate</elementReference>
            </value>
        </filters>
        <filters>
            <field>End_Date__c</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>$Record.CreatedDate</elementReference>
            </value>
        </filters>
        <filters>
            <field>ExchangeCurrencyFrom__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.CurrencyBuying__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>ExchangeCurrencyFrom__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.CurrencySelling__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>FxRate__c</object>
        <sortField>Name</sortField>
        <sortOrder>Desc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_F_TMS_Bill</name>
        <label>Update F/TMS Bill</label>
        <locationX>513</locationX>
        <locationY>953</locationY>
        <inputAssignments>
            <field>ExchangeRateBuying__c</field>
            <value>
                <elementReference>Get_Fx_Rate_avaible.BuyingFxRatetoVND__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>ExchangeRateSelling__c</field>
            <value>
                <elementReference>Get_Fx_Rate_avaible.SellingFxRate1__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>FxRateID__c</field>
            <value>
                <elementReference>Get_Fx_Rate_avaible.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceFCY__c</field>
            <value>
                <elementReference>UnitPriceofSellingFCY</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceofBuyingFCY__c</field>
            <value>
                <elementReference>UnitPriceofBuyingFCY</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceofBuyingLocal__c</field>
            <value>
                <elementReference>UnitPriceofBuyingLocal</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceofSellingLocal__c</field>
            <value>
                <elementReference>UnitPriceofSellingLocal</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_F_TMS_Bill_0</name>
        <label>Update F/TMS Bill</label>
        <locationX>1132</locationX>
        <locationY>356</locationY>
        <inputAssignments>
            <field>CurrencyConversionforBuying__c</field>
            <value>
                <elementReference>CurrencyConversionforBuying</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>CurrencyConversionforSelling__c</field>
            <value>
                <elementReference>CurrencyConversionforSelling</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceFCY__c</field>
            <value>
                <elementReference>UnitPriceofSellingFCY</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceofBuyingFCY__c</field>
            <value>
                <elementReference>UnitPriceofBuyingFCY</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceofBuyingLocal__c</field>
            <value>
                <elementReference>UnitPriceofBuyingLocal</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceofSellingLocal__c</field>
            <value>
                <elementReference>UnitPriceofSellingLocal</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_F_TMS_Bill_0_0</name>
        <label>Update F/TMS Bill</label>
        <locationX>327</locationX>
        <locationY>729</locationY>
        <inputAssignments>
            <field>ExchangeRateBuying__c</field>
            <value>
                <elementReference>$Record.FxRateID__r.BuyingFxRatetoVND__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>ExchangeRateSelling__c</field>
            <value>
                <elementReference>$Record.FxRateID__r.SellingFxRate1__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceFCY__c</field>
            <value>
                <elementReference>UnitPriceofSellingFCY</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceofBuyingFCY__c</field>
            <value>
                <elementReference>UnitPriceofBuyingFCY</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceofBuyingLocal__c</field>
            <value>
                <elementReference>UnitPriceofBuyingLocal</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceofSellingLocal__c</field>
            <value>
                <elementReference>UnitPriceofSellingLocal</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_F_TMS_Bill_0_0_0</name>
        <label>Update F/TMS Bill</label>
        <locationX>696</locationX>
        <locationY>1024</locationY>
        <inputAssignments>
            <field>UnitPriceFCY__c</field>
            <value>
                <elementReference>UnitPriceofSellingFCY</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceofBuyingFCY__c</field>
            <value>
                <elementReference>UnitPriceofBuyingFCY</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceofBuyingLocal__c</field>
            <value>
                <elementReference>UnitPriceofBuyingLocal</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>UnitPriceofSellingLocal__c</field>
            <value>
                <elementReference>UnitPriceofSellingLocal</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <start>
        <locationX>650</locationX>
        <locationY>45</locationY>
        <connector>
            <targetReference>Check_condition</targetReference>
        </connector>
        <filterFormula>OR(ISNEW(),ISCHANGED({!$Record.FxRateID__c}), ISCHANGED({!$Record.UnitPriceofBuyingFCY__c}), ISCHANGED({!$Record.UnitPriceofSellingLocal__c}), ISCHANGED({!$Record.UnitPriceFCY__c}), ISCHANGED({!$Record.UnitPriceofBuyingLocal__c}),ISCHANGED({!$Record.UnitPriceofBuyingFCY__c}),ISCHANGED({!$Record.ExchangeRateBuying__c}), 
ISCHANGED({!$Record.ExchangeRateSelling__c}))</filterFormula>
        <object>FTMSBill__c</object>
        <recordTriggerType>CreateAndUpdate</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <triggerOrder>2</triggerOrder>
</Flow>
